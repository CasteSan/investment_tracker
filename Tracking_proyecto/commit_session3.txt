# =============================================================================
# COMMIT MESSAGE - SESI√ìN 3: Portfolio Module + Fixes Multi-Divisa
# =============================================================================
# Ejecutar: git add . && git commit -F commit_session3.txt
# =============================================================================

feat(portfolio): Implementar m√≥dulo de an√°lisis de cartera con soporte multi-divisa

SESI√ìN 3: Portfolio Module - An√°lisis completo de cartera y rentabilidades

## üì¶ NUEVOS ARCHIVOS

### src/portfolio.py (~700 l√≠neas)
M√≥dulo principal de an√°lisis de cartera con:
- C√°lculo de posiciones actuales con FIFO
- Plusval√≠as latentes y realizadas
- Rentabilidad total y por activo
- Distribuci√≥n de cartera (por activo, tipo, sector)
- Estad√≠sticas avanzadas (volatilidad, correlaciones)
- Funciones de conveniencia para visualizaci√≥n (print_positions, print_realized_gains)

Caracter√≠sticas clave:
- Soporte para campo `display_name` (muestra nombres en lugar de tickers)
- Usa `realized_gain_eur` del CSV para B/P correcta en cualquier divisa
- C√°lculo correcto de "total invertido" (solo posiciones actuales, no hist√≥rico)

### test_portfolio.py
Suite de 8 tests que verifican:
1. Posiciones actuales con nombres
2. Divisas y mercados (EUR, USD, GBX, CAD)
3. Plusval√≠as realizadas (verificaci√≥n Tullow Oil = -143‚Ç¨, no -12,420‚Ç¨)
4. Rentabilidad total
5. Performance por activo
6. Distribuci√≥n de cartera
7. Resumen completo
8. Estad√≠sticas

## üîß ARCHIVOS MODIFICADOS

### src/database.py (v2)
Nuevos campos en modelo Transaction:
- `currency` (String): EUR, USD, GBX, CAD, GBP
- `market` (String): BME, NYSE, NASDAQ, LON, etc.
- `realized_gain_eur` (Float): B/P de venta YA en EUR (del CSV)
- `unrealized_gain_eur` (Float): B/P latente YA en EUR

Nuevos m√©todos:
- `get_currencies_used()`: Lista de divisas en la cartera
- `get_markets_used()`: Lista de mercados
- `clear_all_data(confirm)`: Limpia todas las tablas

### src/data_loader.py (v2)
Actualizado para importar campos nuevos:
- Mapeo de columnas: currency, market, realized_gain_eur, unrealized_gain_eur
- Parseo correcto de n√∫meros negativos en formato europeo
- Compatible con CSV generado por convert_investing_csv.py

### scripts/convert_investing_csv.py (antes v4)
Conversor completo de CSV de Investing.com:
- Extrae columna "B/P neto" del CSV (ya convertida a EUR por Investing)
- Guarda en campo `realized_gain_eur` para evitar errores de conversi√≥n
- Detecta divisa seg√∫n mercado (LON=GBX, NYSE/NASDAQ=USD, etc.)
- Detecta tipo de activo (accion, fondo, etf)

## üêõ BUGS CORREGIDOS

### Bug cr√≠tico: Tullow Oil mostraba -12,420‚Ç¨ en lugar de -143‚Ç¨
- Causa: Precios en peniques (GBX) tratados como euros
- Soluci√≥n: Usar columna "B/P neto" del CSV que ya est√° en EUR
- El conversor ahora extrae este valor y lo guarda en `realized_gain_eur`
- portfolio.py usa este campo cuando est√° disponible

### Bug: "Total invertido" mostraba 95,000‚Ç¨ en lugar de ~33,000‚Ç¨
- Causa: Sumaba TODAS las compras hist√≥ricas (incluso las ya vendidas)
- Soluci√≥n: Usar `get_total_cost_basis()` que calcula solo posiciones actuales
- Ahora refleja correctamente cu√°nto cost√≥ adquirir lo que se tiene

### Bug: Outputs mostraban tickers cr√≠pticos en lugar de nombres
- Antes: LP68478350
- Ahora: Fidelity S&P 500 Index Fund EUR P Acc
- A√±adido campo `display_name` en todos los outputs

## üìä RESULTADOS VERIFICADOS

```
Total invertido: 32,770‚Ç¨ (correcto, solo posiciones actuales)
Valor actual: 33,277‚Ç¨
Ganancia latente: +507‚Ç¨
Ganancia realizada: -1,124‚Ç¨ (incluye Tullow Oil = -143‚Ç¨ correcto)
Rentabilidad: -1.88%

Divisas: EUR, USD, GBX, CAD
Mercados: BME, NYSE, NASDAQ, LON, BIT, ETR, EPA, LU, IR, TSXV
```

## üí° NOTAS T√âCNICAS

- El esquema de la DB cambi√≥: requiere eliminar database.db y reimportar
- Flujo de trabajo: convert_investing_csv.py ‚Üí data_loader.py ‚Üí portfolio.py
- Para activos en divisas extranjeras, confiar en B/P de Investing (ya en EUR)

## üìã PR√ìXIMOS PASOS (Sesi√≥n 4)

- Tax Calculator: C√°lculos fiscales FIFO/LIFO configurables
- Informe fiscal anual para declaraci√≥n de la renta
- Simulaci√≥n de impacto fiscal antes de vender
