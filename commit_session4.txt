# =============================================================================
# COMMIT MESSAGE - SESI√ìN 4: Tax Calculator Module
# =============================================================================
# Ejecutar: git add . && git commit -F commit_session4.txt
# =============================================================================

feat(tax): Implementar m√≥dulo de c√°lculos fiscales con FIFO e informes para la renta

SESI√ìN 4: Tax Calculator - Gesti√≥n fiscal completa de inversiones

## üì¶ NUEVOS ARCHIVOS

### src/tax_calculator.py (~750 l√≠neas)
M√≥dulo completo de gesti√≥n fiscal con:

**Gesti√≥n de Lotes:**
- get_available_lots(ticker): Lotes no vendidos de un activo
- get_all_available_lots(): Todos los lotes de la cartera
- assign_lots_to_sale(): Asignaci√≥n FIFO/LIFO a ventas

**C√°lculo de Plusval√≠as:**
- calculate_sale_gain(): Plusval√≠a de una venta espec√≠fica
- get_fiscal_year_summary(): Resumen anual (ganancias, p√©rdidas, neto)
- get_fiscal_year_detail(): Detalle de cada venta del a√±o

**Regla Antiaplicaci√≥n (2 meses):**
- check_wash_sale(): Verifica si una venta est√° afectada
- get_wash_sales_in_year(): Lista todas las ventas afectadas
- Detecta compras en los 60 d√≠as antes/despu√©s de venta con p√©rdidas

**C√°lculo de Impuestos (IRPF Ahorro Espa√±a):**
- calculate_tax(): Aplica tramos IRPF del ahorro:
  - Hasta 6.000‚Ç¨: 19%
  - 6.000‚Ç¨ - 50.000‚Ç¨: 21%
  - 50.000‚Ç¨ - 200.000‚Ç¨: 23%
  - 200.000‚Ç¨ - 300.000‚Ç¨: 27%
  - M√°s de 300.000‚Ç¨: 28%

**Simulaci√≥n:**
- simulate_sale(): Simula venta SIN ejecutar
- Muestra ganancia, impuesto estimado, lotes que se vender√≠an
- Avisa si aplica regla de los 2 meses

**Exportaci√≥n:**
- export_fiscal_report(): Genera Excel con 6 hojas:
  1. Resumen (ganancias, p√©rdidas, impuesto)
  2. Detalle Ventas (cada operaci√≥n)
  3. Regla 2 Meses (p√©rdidas no deducibles)
  4. Lotes Disponibles (posiciones por fecha compra)
  5. Por Trimestre (Q1-Q4)
  6. Desglose Impuesto (por tramos)

**Funciones de Conveniencia:**
- print_fiscal_summary(year): Imprime resumen formateado
- print_available_lots(ticker): Imprime lotes disponibles
- print_simulation(ticker, qty, price): Imprime simulaci√≥n

### test_tax_calculator.py (~300 l√≠neas)
Suite de 10 tests:
1. Lotes disponibles
2. Resumen fiscal 2025
3. Detalle fiscal
4. C√°lculo de impuestos por tramos
5. Detecci√≥n regla 2 meses
6. Simulaci√≥n de venta
7. Comparaci√≥n FIFO vs LIFO
8. Exportaci√≥n a Excel
9. Resumen dividendos
10. Funciones de impresi√≥n

## üîß CARACTER√çSTICAS T√âCNICAS

- M√©todo por defecto: FIFO (configurable a LIFO)
- Usa realized_gain_eur del CSV para precisi√≥n multi-divisa
- Integraci√≥n con database.py y portfolio.py existentes
- Requiere openpyxl para exportaci√≥n Excel

## üìä EJEMPLO DE USO

```python
from src.tax_calculator import TaxCalculator

tax = TaxCalculator(method='FIFO')

# Resumen fiscal
tax.print_fiscal_summary(2025)

# Simular venta antes de hacerla
tax.print_simulation('TEF', 100, 4.50)

# Exportar informe para la renta
tax.export_fiscal_report(2025, 'informe_fiscal_2025.xlsx')

tax.close()
```

## üìã DEPENDENCIAS A√ëADIDAS

- openpyxl (para exportaci√≥n Excel)

## ‚úÖ TESTS

Todos los tests pasan correctamente:
- 10/10 tests pasados
- Verificado con datos reales de cartera
- Exportaci√≥n Excel funcional

## üìã PR√ìXIMOS PASOS (Sesi√≥n 5)

- Dividends Module: Gesti√≥n completa de dividendos
- Registro con retenciones
- Yield sobre precio de compra
- Calendario de cobros
